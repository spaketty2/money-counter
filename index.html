<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>นับเงิน + คีย์บอร์ดเสมือน</title>
  <style>
    /* [คงเดิม] ... */
    * { user-select: none; -webkit-user-select: none; -ms-user-select: none; }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: #3a3a3a;
      color: #ffffff;
      font-family: Tahoma, sans-serif;
      box-sizing: border-box;
    }
    body {
      padding: 6px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }
    #frame { flex: 1 1 auto; overflow-y: auto; }
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin: 2px 0;
    }
    button {
      background: #4c4c4c;
      color: #ffffff;
      border: none;
      padding: 10px 0;
      margin: 1px;
      font-size: 12px;
      border-radius: 4px;
      cursor: pointer;
      width: 38px;
    }
    button:active { background: #00aaff; }
    input[type="text"] {
      background: #5c5c5c;
      color: #ffffff;
      border: none;
      text-align: center;
      font-size: 12px;
      padding: 10px;
      border-radius: 4px;
      margin: 1px;
      width: 46px;
    }
    .label { flex: 0 0 36px; text-align: center; font-size: 12px; }
    .multiply {
      flex: 1;
      text-align: right;
      font-size: 12px;
      padding-right: 6px;
      min-width: 40px;
    }
    .clear-btn {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 8px 0;
    }
    .sum-section, .floating-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: bold;
      font-size: 14px;
      margin: 6px 0;
      flex-wrap: wrap;
    }
    .floating-label input {
      width: 100px;
      font-size: 14px;
      text-align: right;
      padding: 10px;
      background: #5c5c5c;
      color: #ffffff;
      border: none;
      border-radius: 4px;
      margin-left: 8px;
    }
    .green {
      color: #00ff88;
      min-width: 60px;
      text-align: right;
    }
    #numpad-container {
      position: fixed;
      bottom: 0;
      right: 0;
      width: 60%;
      height: auto;
      z-index: 9999;
      background: transparent;
      display: none;
    }
    #numpad-display {
      text-align: right;
      font-size: 18px;
      padding: 10px 14px;
      background: #111;
      color: #00ff88;
      border-top-left-radius: 10px;
    }
    #numpad {
      background: #222;
      display: none;
      padding: 10px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
    }
    .numpad-row {
      display: flex;
      justify-content: center;
      margin-bottom: 6px;
    }
    .numpad-btn {
      width: 50px;
      height: 50px;
      margin: 3px;
      font-size: 20px;
      border: none;
      border-radius: 8px;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    .numpad-btn:active { background: #00aaff; }

    /* ปุ่มล็อค */
    #lock-btn {
      font-size: 13px;
      height: 34px;
      width: 45px;
      margin-left: 1px;
    }
    .locked { color: yellow; }
    .unlocked { color: white; }
  </style>
</head>
<body>

<div id="frame"></div>

<!-- เพิ่มปุ่ม Undo / Redo ทางซ้ายของ Clear ตามสเปค -->
<div class="clear-btn">
  <button id="undo-btn" style="width: 52px" onclick="__undo()"> Undo </button>
  <button id="redo-btn" style="width: 52px" onclick="__redo()"> Redo </button>
  <button style="width: 100%" onclick="clearAll()">Clear</button>
  <button id="lock-btn" class="unlocked" style="width: 60px" onclick="toggleLock()">Unlock</button>
</div>

<div class="sum-section">
  <div>รวม</div>
  <div id="total-sum" class="green">0</div>
</div>

<div class="floating-label">
  <div>ยอดโอน</div>
  <input type="text" id="transfer" value="0" onclick="showNumpad()" readonly>
</div>

<div class="sum-section">
  <div>รวมค่าธรรมเนียม</div>
  <div id="total-fee" class="green">0</div>
</div>

<div class="sum-section">
  <div>ขาดเหลือ</div>
  <div id="total-diff" class="green">0</div>
</div>

<div style="margin-bottom: 80px"></div>

<div id="numpad-container">
  <div id="numpad-display">0</div>
  <div id="numpad">
    <div class="numpad-row">
      <button class="numpad-btn" onclick="numpadPress('1')">1</button>
      <button class="numpad-btn" onclick="numpadPress('2')">2</button>
      <button class="numpad-btn" onclick="numpadPress('3')">3</button>
    </div>
    <div class="numpad-row">
      <button class="numpad-btn" onclick="numpadPress('4')">4</button>
      <button class="numpad-btn" onclick="numpadPress('5')">5</button>
      <button class="numpad-btn" onclick="numpadPress('6')">6</button>
    </div>
    <div class="numpad-row">
      <button class="numpad-btn" onclick="numpadPress('7')">7</button>
      <button class="numpad-btn" onclick="numpadPress('8')">8</button>
      <button class="numpad-btn" onclick="numpadPress('9')">9</button>
    </div>
    <div class="numpad-row">
      <button class="numpad-btn" onclick="hideNumpad()">V</button>
      <button class="numpad-btn" onclick="deleteLastChar()">Del</button>
      <button class="numpad-btn" onclick="numpadPress('0')">0</button>
    </div>
  </div>
</div>

<script>
  let isLocked = false;

  const prices = {
    bn1000: 1000, bn500: 500, bn100: 100, bn50: 50, bn20: 20,
    c10: 10, c5: 5, c2: 2, c1: 1, p100: 100, n: 1
  };
  const values = {};
  for (let k in prices) values[k] = 0;

  function lockCheck(callback) {
    return function (...args) {
      if (!isLocked) callback(...args);
    }
  }

  function createRow(key, label) {
    const frame = document.getElementById("frame");
    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML =
      `<div class="multiply" id="${key}_mul">0</div>
      <button onclick="lockCheck(clearValue)('${key}')">C</button>
      <button onclick="lockCheck(changeValue)('${key}', -1)">-1</button>
      <div class="label">${label}</div>
      <input type="text" id="${key}" value="0" inputmode="numeric"
             onfocus="lockCheck(onFocusIn)(this)" onblur="lockCheck(onFocusOut)(this, '${key}')"
             oninput="lockCheck(onValueChange)(this, '${key}')" 
             onkeypress="return isNumberKey(event)">
      <button onclick="lockCheck(changeValue)('${key}', 1)">+1</button>
      <button onclick="lockCheck(changeValue)('${key}', 10)">+10</button>`;
    frame.appendChild(row);
  }

  function toggleLock() {
    isLocked = !isLocked;
    const lockBtn = document.getElementById("lock-btn");
    lockBtn.innerText = isLocked ? 'Lock' : 'Unlock';
    lockBtn.className = isLocked ? 'locked' : 'unlocked';
  }

  function isNumberKey(evt) {
    if (isLocked) return false;
    const charCode = evt.which ? evt.which : evt.keyCode;
    return charCode >= 48 && charCode <= 57;
  }

  function changeValue(key, delta) {
    values[key] = Math.max(values[key] + delta, 0);
    document.getElementById(key).value = values[key];
    updateMultiply(key);
    saveToLocalStorage();
  }

  function clearValue(key) {
    values[key] = 0;
    document.getElementById(key).value = 0;
    updateMultiply(key);
    saveToLocalStorage();
  }

  function updateMultiply(key) {
    let mul = prices[key] * values[key];
    document.getElementById(key + "_mul").innerText = mul.toLocaleString();
    updateTotal();
  }

  function updateTotal() {
    let total = Object.keys(prices).reduce((sum, k) => sum + prices[k] * values[k], 0);
    document.getElementById("total-sum").innerText = total.toLocaleString();
    updateFeeAndDiff();
  }

  function clearAll() {
    if (isLocked) return;
    for (let k in prices) clearValue(k);
    document.getElementById("transfer").value = '0';
    document.getElementById("numpad-display").innerText = '0';
    hideNumpad();
    updateFeeAndDiff();
    saveToLocalStorage();
  }

  function onFocusIn(input) {
    if (input.value === "0") input.value = "";
    input.style.color = "#ffffff";
  }

  function onFocusOut(input, key) {
    if (!input.value) {
      input.value = "0";
      input.style.color = "#ffffff";
    }
    values[key] = parseInt(input.value) || 0;
    updateMultiply(key);
    saveToLocalStorage();
  }

  function onValueChange(input, key) {
    values[key] = Math.max(parseInt(input.value) || 0, 0);
    updateMultiply(key);
    saveToLocalStorage();
  }

  function updateFeeAndDiff() {
    let transfer = parseInt(document.getElementById("transfer").value.replace(/,/g, "")) || 0;
    let fee = transfer + 15;
    document.getElementById("total-fee").innerText = fee.toLocaleString();
    let total = parseInt(document.getElementById("total-sum").innerText.replace(/,/g, "")) || 0;
    let diff = total - fee;
    document.getElementById("total-diff").innerText = diff.toLocaleString();
  }

  const labels = {
    bn1000: '1000', bn500: '500', bn100: '100', bn50: '50', bn20: '20',
    c10: '10', c5: '5', c2: '2', c1: '1', p100: '100', n: '...'
  };
  for (let k in labels) createRow(k, labels[k]);

  function showNumpad() {
    if (isLocked) return;
    document.getElementById('numpad').style.display = 'block';
    document.getElementById('numpad-container').style.display = 'block';
    document.getElementById('numpad-display').innerText = document.getElementById('transfer').value;
  }

  function hideNumpad() {
    document.getElementById('numpad').style.display = 'none';
    document.getElementById('numpad-container').style.display = 'none';
    updateFeeAndDiff();
  }

  function numpadPress(num) {
    if (isLocked) return;
    let input = document.getElementById('transfer');
    let current = input.value.replace(/,/g, '');
    if (current === '0') current = '';
    input.value = formatNumber(current + num);
    document.getElementById('numpad-display').innerText = input.value;
    saveToLocalStorage();
  }

  function deleteLastChar() {
    if (isLocked) return;
    let input = document.getElementById('transfer');
    let current = input.value.replace(/,/g, '');
    current = current.slice(0, -1);
    input.value = formatNumber(current || '0');
    document.getElementById('numpad-display').innerText = input.value;
    saveToLocalStorage();
  }

  function formatNumber(val) {
    let num = parseInt(val);
    return isNaN(num) ? '0' : num.toLocaleString();
  }

  function saveToLocalStorage() {
    localStorage.setItem("values", JSON.stringify(values));
    localStorage.setItem("transfer", document.getElementById("transfer").value);
  }

  function loadFromLocalStorage() {
    const storedValues = localStorage.getItem("values");
    const storedTransfer = localStorage.getItem("transfer");
    if (storedValues) {
      const parsed = JSON.parse(storedValues);
      for (let k in parsed) {
        values[k] = parsed[k];
        const el = document.getElementById(k);
        if (el) {
          el.value = parsed[k];
          updateMultiply(k);
        }
      }
    }
    if (storedTransfer) {
      document.getElementById("transfer").value = storedTransfer;
      updateFeeAndDiff();
    }
  }

  window.onload = function () {
    loadFromLocalStorage();
  };

  document.addEventListener("click", function (event) {
    const numpadContainer = document.getElementById("numpad-container");
    const transferInput = document.getElementById("transfer");
    if (
      !numpadContainer.contains(event.target) &&
      event.target !== transferInput
    ) {
      hideNumpad();
    }
  });
</script>

<!-- ====================== ยืนยันล้างข้อมูล (จากเวอร์ชัน 1.1) ====================== -->
<style>
  #confirm-clear {
    position: fixed;
    inset: 0;
    display: none;               /* เปิดเป็น flex เมื่อโชว์ */
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.35); /* พื้นหลังมืดเล็กน้อย */
    z-index: 99999;
  }
  #confirm-clear .cc-modal {
    width: 320px;
    max-width: calc(100% - 48px);
    border-radius: 16px;
    background: #fff;
    color: #111;
    box-shadow: 0 12px 36px rgba(0,0,0,.35);
    overflow: hidden;
    font-family: inherit;
  }
  @media (prefers-color-scheme: dark) {
    #confirm-clear .cc-modal { background:#1f1f1f; color:#f5f5f5; }
  }
  #confirm-clear .cc-head { font-weight:700; padding:16px 16px 8px; font-size:16px; }
  #confirm-clear .cc-body { padding:0 16px 12px; font-size:14px; opacity:.95; }
  #confirm-clear .cc-actions {
    display:flex; gap:10px; justify-content:flex-end; align-items:center;
    padding:10px 16px 16px;
  }
  #confirm-clear .cc-btn {
    appearance:none; border:0; border-radius:12px;
    padding:8px 14px; font-size:14px; line-height:1.3; cursor:pointer;
    width:auto; display:inline-block; white-space:nowrap;
  }
  #confirm-clear .cc-btn.outline { background:transparent; border:1px solid rgba(0,0,0,.25); }
  @media (prefers-color-scheme: dark) {
    #confirm-clear .cc-btn.outline { border-color: rgba(255,255,255,.35); }
  }
  #confirm-clear .cc-btn.primary { background:#1a73e8; color:#fff; }
  #confirm-clear .cc-btn.primary:active { transform: translateY(1px); }
</style>

<div id="confirm-clear" onclick="__dismissConfirmClear(event)">
  <div class="cc-modal" role="dialog" aria-modal="true" aria-labelledby="cc-title">
    <div class="cc-head" id="cc-title">ล้างข้อมูลทั้งหมด?</div>
    <div class="cc-body">คุณต้องการจะล้างข้อมูลที่นับไว้ทั้งหมดหรือไม่</div>
    <div class="cc-actions">
      <button type="button" class="cc-btn outline" onclick="__hideConfirmClear()">ยกเลิก</button>
      <button type="button" class="cc-btn primary" onclick="__confirmClear()">ยืนยัน</button>
    </div>
  </div>
</div>

<script>
  /* หุ้ม clearAll เดิม (ไม่แก้ตรรกะเดิม) + เตรียม undo/redo wrap ภายหลัง */
  (function () {
    if (typeof window.clearAll !== 'function') return;

    const __clearAllOriginal = window.clearAll;

    function __showConfirmClear() {
      const ov = document.getElementById('confirm-clear');
      if (!ov) return;
      ov.style.display = 'flex';
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }
    function __hideConfirmClear() {
      const ov = document.getElementById('confirm-clear');
      if (!ov) return;
      ov.style.display = 'none';
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }
    function __dismissConfirmClear(e) {
      if (e.target && e.target.id === 'confirm-clear') __hideConfirmClear();
    }
    function __confirmClear() {
      __hideConfirmClear();
      __clearAllOriginal(); // ล้างจริงเมื่อยืนยัน
    }

    window.__hideConfirmClear = __hideConfirmClear;
    window.__dismissConfirmClear = __dismissConfirmClear;
    window.__confirmClear = __confirmClear;

    document.addEventListener('keydown', function (ev) {
      const ov = document.getElementById('confirm-clear');
      if (!ov || ov.style.display !== 'flex') return;
      if (ev.key === 'Escape') __hideConfirmClear();
      if (ev.key === 'Enter') __confirmClear();
    });

    window.clearAll = function () { __showConfirmClear(); };
  })();
</script>
<!-- ====================== /ยืนยันล้างข้อมูล (1.1) ====================== -->

<!-- ====================== เพิ่ม Undo/Redo (1.2) ====================== -->
<script>
  (function () {
    const MAX_HISTORY = 20;
    let __history = [];
    let __future = [];
    let __isRestoring = false;

    function __snapshot() {
      // เก็บ values และ transfer ปัจจุบัน
      const snap = {
        values: {},
        transfer: document.getElementById("transfer").value
      };
      for (const k in prices) snap.values[k] = values[k] || 0;
      return snap;
    }

    function __applyState(state) {
      __isRestoring = true;
      // set values + inputs + mul
      for (const k in prices) {
        values[k] = state.values[k] || 0;
        const el = document.getElementById(k);
        if (el) {
          el.value = values[k];
          const mulEl = document.getElementById(k + "_mul");
          if (mulEl) mulEl.innerText = (values[k] * prices[k]).toLocaleString();
        }
      }
      // set transfer
      const t = document.getElementById("transfer");
      if (t) t.value = state.transfer || "0";
      // update sums
      if (typeof updateTotal === 'function') updateTotal();
      if (typeof updateFeeAndDiff === 'function') updateFeeAndDiff();
      if (typeof saveToLocalStorage === 'function') saveToLocalStorage();
      __isRestoring = false;
    }

    function __pushHistory() {
      if (__isRestoring) return;
      const snap = __snapshot();
      __history.push(snap);
      if (__history.length > MAX_HISTORY) __history.shift();
      // การทำงานใหม่ทำให้อนาคตเป็นโมฆะ
      __future.length = 0;
    }

    // เริ่มต้นเก็บสถานะเริ่ม
    window.addEventListener('load', function () {
      __pushHistory();
    });

    // หุ้มฟังก์ชันที่เปลี่ยนสถานะให้เก็บประวัติ (โดยไม่แก้เนื้อใน)
    function __wrap(fnName) {
      const fn = window[fnName];
      if (typeof fn !== 'function') return;
      window[fnName] = function (...args) {
        __pushHistory();
        return fn.apply(this, args);
      };
    }
    __wrap('changeValue');
    __wrap('clearValue');
    __wrap('onValueChange');
    __wrap('numpadPress');
    __wrap('deleteLastChar');

    // clearAll จะถูกเรียกผ่าน __confirmClear อยู่แล้ว -> หุ้ม __confirmClear เพื่อเก็บประวัติ
    if (typeof window.__confirmClear === 'function') {
      const prevConfirm = window.__confirmClear;
      window.__confirmClear = function () {
        __pushHistory();   // เก็บสถานะก่อนล้าง
        return prevConfirm();
      };
    }

    // ปุ่ม Undo/Redo
    window.__undo = function () {
      if (__history.length === 0) return;
      const current = __snapshot();
      const prev = __history.pop();
      if (!prev) return;
      __future.push(current);
      if (__future.length > MAX_HISTORY) __future.shift();
      __applyState(prev);
    };

    window.__redo = function () {
      if (__future.length === 0) return;
      const current = __snapshot();
      const next = __future.pop();
      if (!next) return;
      __history.push(current);
      if (__history.length > MAX_HISTORY) __history.shift();
      __applyState(next);
    };
  })();
</script>
<!-- ====================== /เพิ่ม Undo/Redo (1.2) ====================== -->

</body>
</html>
